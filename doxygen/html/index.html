<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>cr_lib: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">cr_lib
   &#160;<span id="projectnumber">v1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">cr_lib Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>cr_lib is a simple, portable, cooperative multitasking environment using coroutines. It features a mechanism for exiting and re-entering a function in a non-standard way using the standard C library's setjmp and longjmp functions. Coroutine threads run one at a time, are persistent for the lifetime of the application, and each thread must be explicitly scheduled. cr_lib does include a system coroutine, cr_idle, that can be used in conjunction with the variable cr_g_activate_id to activate a coroutine. cr_g_activate_id could be used, for example, in an ISR routine of an event driven system. <br/>
 cr_lib is probably most useful for micro-controllers, DSPs, small GPPs, or educational purposes.</p>
<p><b> What is a coroutine: </b> <br/>
 "A coroutine is represented by a closure (a code address and a referencing environment), into which we can jump by means of a nonlocal goto - in this case a special operation known as a transfer. In effect, coroutines are execution contexts that exist concurrently but execute one at a time, and transfer control to each other explicitly by name." From <em> Programming Language Pragmatics by Morgan Kaufmann </em> <br/>
 <b> Using cr_lib </b></p>
<ul>
<li>Initialize cr_lib by calling "cr_init" with the appropriate paramters</li>
<li>Create a coroutine by calling "cr_register_thread"</li>
<li>Call "CR_START" with the name of the coroutine to bootstrap the system</li>
<li>Call "CR_THREAD_INIT" at the start of each coroutine thread</li>
<li>Call "CR_YIELD" at the desired points within coroutine thread</li>
</ul>
<div class="fragment"><div class="line">example of initialization, registration, and start of cr_lib</div>
<div class="line">------------------------------------------------------------</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CONTEXT_ARRAY_CNT   (2 + 1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><a class="code" href="struct_c_r___c_o_n_t_e_x_t.html">CR_CONTEXT</a> context_array[CONTEXT_ARRAY_CNT];</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// 1. initialize cr_lib</span></div>
<div class="line">  <a class="code" href="cr_8c.html#aca6b87323f9ce0bf21b3f06209a97989">cr_init</a>(context_array, CONTEXT_ARRAY_CNT);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// 2. register functions</span></div>
<div class="line">  <a class="code" href="cr_8c.html#ae30bdb4ef569c0678e4cb49829f11bbb">cr_register_thread</a>(Thread_A);</div>
<div class="line">  <a class="code" href="cr_8c.html#ae30bdb4ef569c0678e4cb49829f11bbb">cr_register_thread</a>(Thread_B);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// 3. bootstrap system</span></div>
<div class="line">  <a class="code" href="cr_8h.html#ad89b832374912ca6c097b550a95a8ebf">CR_START</a>(Thread_A);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">coroutine 1</div>
<div class="line">-----------</div>
<div class="line"><span class="keywordtype">void</span> Thread_A(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="cr_8h.html#ac68ef77f5ea5f5dda5a2f046a2c96429">CR_THREAD_INIT</a>();</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <span class="comment">// main body of code</span></div>
<div class="line">    <a class="code" href="cr_8h.html#a18adb578c9437579bc39134852d4fc5b">CR_YIELD</a>(Thread_B);</div>
<div class="line">    <span class="comment">// user code</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">coroutine 2</div>
<div class="line">-----------</div>
<div class="line"><span class="keywordtype">void</span> Thread_B(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="cr_8h.html#ac68ef77f5ea5f5dda5a2f046a2c96429">CR_THREAD_INIT</a>();</div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="comment">// main body of code</span></div>
<div class="line">    <a class="code" href="cr_8h.html#a18adb578c9437579bc39134852d4fc5b">CR_YIELD</a>(<a class="code" href="cr_8c.html#accd73b48023970380bfdecb56483976c">cr_idle</a>);</div>
<div class="line">    <span class="comment">// user code</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">Note: locals within a corouitne thread should use the <span class="stringliteral">&#39;volatile&#39;</span> qualifier, e.g.</div>
<div class="line"></div>
<div class="line">void Thread_A(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// locals use the &#39;volatile&#39; qualifier</span></div>
<div class="line">  int32_t <span class="keyword">volatile</span> count = 0;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="cr_8h.html#ac68ef77f5ea5f5dda5a2f046a2c96429">CR_THREAD_INIT</a>();</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    count += 1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// main body of code</span></div>
<div class="line">    <a class="code" href="cr_8h.html#a18adb578c9437579bc39134852d4fc5b">CR_YIELD</a>(Thread_B);</div>
<div class="line">    <span class="comment">// user code</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b> Misc. Notes </b></p>
<ul>
<li>cr_init's cr_context parameter requires 1 extra element for the system's "cr_idle" coroutine. Therefore, set the cr_context_count equal to the number of coroutine threads plus one.</li>
<li>"cr_init" must be called before registering any coroutine threads</li>
<li>Coroutine thread's must take a "void" parameter and return "void."</li>
<li>A coroutine thread must call "CR_THREAD_INIT" at the top of the function before calling "CR_YIELD".</li>
<li>Register a coroutine thread using "cr_register_thread" where the coroutine thread's name is passed as a parameter.</li>
<li>Once all the coroutine threads are registered call "CR_START" with either a user coroutine thread name or the cr_idle coroutine name.</li>
<li>"cr_init" takes a user declared array of "CR_CONTEXT" and its element count plus 1. There needs to be an extra element reserved for the "cr_idle" coroutine.</li>
<li>Functions registered as coroutine threads should not return. I.e. the body of the main part of the code should be wrapped in an endless "for" or "while" loop.</li>
<li>The global variable "cr_g_activate_id" can be used to activate a coroutine by setting it to a coroutine's ID. For it to work the idle coroutine (cr_idle) must be yielded to explicitly at some point. Have a look at the demo_2 and demo_4 files. Each simulates an ISR type of external event. Be careful when scheduling events using "cr_g_activate_id"; there's no buffering of the coroutine ID's being assigned. Use "cr_get_id()" - passing a coroutine function name - to determine the ID of a coroutine.</li>
<li>The longjmp's second parameter could probably be used to identify the previously running coroutine and to set the cr_g_previous_cr_id variable once the jump is completed. To do so would require sanity checking that there aren't more coroutines registered than the size of the longjmp's second parameter type, but it would really only save two or three lines of code in the macros. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Sep 7 2014 14:40:36 for cr_lib by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
