<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>cr_lib: cr.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>cr.c</h1><a href="cr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;stdbool.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="cr__config_8h.html">cr_config.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="cr_8h.html">cr.h</a>"</span>
<a name="l00026"></a>00026 
<a name="l00156"></a>00156 <span class="keyword">enum</span> {
<a name="l00157"></a><a class="code" href="cr_8c.html#06fc87d81c62e9abb8790b6e5713c55b84eb6a791d344cea4fadd2638f7b460e">00157</a>     <a class="code" href="cr_8c.html#06fc87d81c62e9abb8790b6e5713c55b84eb6a791d344cea4fadd2638f7b460e">CR_ERROR_CR_EXITING</a> = 0 
<a name="l00158"></a>00158 };
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 jmp_buf             cr_g_reg_func_env;
<a name="l00161"></a>00161 
<a name="l00165"></a><a class="code" href="cr_8h.html#22841ff791649abd0bcb62392ebb9778">00165</a> <a class="code" href="struct_c_r___c_o_n_t_e_x_t.html" title="Coroutine context information.">CR_CONTEXT</a>*         <a class="code" href="cr_8c.html#22841ff791649abd0bcb62392ebb9778" title="Pointer to the user defined array of coroutine contexts.">cr_g_context</a>        = 0;
<a name="l00166"></a>00166 
<a name="l00170"></a><a class="code" href="cr_8h.html#8238e77b653b2cc4905373b805fc3567">00170</a> uint32_t            <a class="code" href="cr_8c.html#8238e77b653b2cc4905373b805fc3567" title="The number of elements in the coroutine context array.">cr_g_context_cnt</a>    = 0;
<a name="l00171"></a>00171 
<a name="l00174"></a><a class="code" href="cr_8h.html#1345c6db4d2d1d939e7841da46704d8e">00174</a> <a class="code" href="cr_8h.html#e9a0f05a9df6e08a47e828db183fa186" title="Coroutine ID typedef.">cr_id_t</a>             <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a>    = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a>;
<a name="l00175"></a>00175 
<a name="l00179"></a><a class="code" href="cr_8h.html#00999e3368c59592db0c069abf1f1296">00179</a> int32_t             <a class="code" href="cr_8c.html#00999e3368c59592db0c069abf1f1296" title="Flag that&amp;#39;s set when CR_START is called.">cr_g_sys_started</a>    = <span class="keyword">false</span>;
<a name="l00180"></a>00180 
<a name="l00184"></a><a class="code" href="cr_8h.html#cf4ab64c8de56045d84e53b65dba7eb8">00184</a> <a class="code" href="cr_8h.html#e9a0f05a9df6e08a47e828db183fa186" title="Coroutine ID typedef.">cr_id_t</a>             <a class="code" href="cr_8c.html#cf4ab64c8de56045d84e53b65dba7eb8" title="The ID of the coroutine that&amp;#39;s active.">cr_g_current_cr_id</a>  = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a>;
<a name="l00185"></a>00185 
<a name="l00189"></a><a class="code" href="cr_8h.html#e7e93574baec3ae2b083c7f36916fbbd">00189</a> <a class="code" href="cr_8h.html#e9a0f05a9df6e08a47e828db183fa186" title="Coroutine ID typedef.">cr_id_t</a>             <a class="code" href="cr_8c.html#e7e93574baec3ae2b083c7f36916fbbd" title="The ID of the previously active coroutine.">cr_g_previous_cr_id</a>  = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a>;
<a name="l00190"></a>00190 
<a name="l00194"></a>00194 <span class="keyword">static</span> int32_t      cr_g_thread_cnt      = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b7139db075566e7ab9f59a9de7f6d2359f">CR_THREAD_CNT_INIT</a>;
<a name="l00195"></a>00195 
<a name="l00204"></a><a class="code" href="cr_8h.html#3e7a31163658d81c9473e5b637d9eb90">00204</a> <a class="code" href="cr_8h.html#e9a0f05a9df6e08a47e828db183fa186" title="Coroutine ID typedef.">cr_id_t</a> <a class="code" href="cr_8c.html#3e7a31163658d81c9473e5b637d9eb90" title="Find the ID of a coroutine.">cr_get_id</a>( <span class="keywordtype">void</span> ( *pFunc )( <span class="keywordtype">void</span> ) )
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206     int32_t i;
<a name="l00207"></a>00207     <a class="code" href="cr_8h.html#e9a0f05a9df6e08a47e828db183fa186" title="Coroutine ID typedef.">cr_id_t</a> <span class="keywordtype">id</span> = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b7cd063e5de520275d94952e07b5f29b18">CR_INVALID_ID</a>;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">for</span> ( i = 0; i &lt;= cr_g_thread_cnt; i++ )
<a name="l00210"></a>00210     {
<a name="l00211"></a>00211         <span class="keywordflow">if</span> ( cr_g_context[ i ].pFunc == pFunc )
<a name="l00212"></a>00212         {
<a name="l00213"></a>00213             <span class="keywordtype">id</span> = i;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215             <span class="keywordflow">break</span>;
<a name="l00216"></a>00216         }
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="comment">//    printf( "cr_get_id pFunc: 0x%X\n", pFunc );</span>
<a name="l00220"></a>00220 <span class="comment">//    printf( "cr_get_id id: %d\n", id );</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="keywordflow">return</span> id;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00229"></a><a class="code" href="cr_8h.html#3e8d6963f6ee2cc49502186eca21d879">00229</a> <span class="keywordtype">void</span> <a class="code" href="cr_8c.html#3e8d6963f6ee2cc49502186eca21d879" title="Resets the system to an initial state.">cr_reset</a>( <span class="keywordtype">void</span> )
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231     cr_g_context        = 0;
<a name="l00232"></a>00232     <a class="code" href="cr_8c.html#8238e77b653b2cc4905373b805fc3567" title="The number of elements in the coroutine context array.">cr_g_context_cnt</a>    = 0;
<a name="l00233"></a>00233     cr_g_thread_cnt     = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b7139db075566e7ab9f59a9de7f6d2359f">CR_THREAD_CNT_INIT</a>;
<a name="l00234"></a>00234     <a class="code" href="cr_8c.html#e7e93574baec3ae2b083c7f36916fbbd" title="The ID of the previously active coroutine.">cr_g_previous_cr_id</a> = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b7cd063e5de520275d94952e07b5f29b18">CR_INVALID_ID</a>;
<a name="l00235"></a>00235     <a class="code" href="cr_8c.html#cf4ab64c8de56045d84e53b65dba7eb8" title="The ID of the coroutine that&amp;#39;s active.">cr_g_current_cr_id</a>  = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b7cd063e5de520275d94952e07b5f29b18">CR_INVALID_ID</a>;
<a name="l00236"></a>00236     <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a>    = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a>;
<a name="l00237"></a>00237     <a class="code" href="cr_8c.html#00999e3368c59592db0c069abf1f1296" title="Flag that&amp;#39;s set when CR_START is called.">cr_g_sys_started</a>    = <span class="keyword">false</span>;
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00249"></a><a class="code" href="cr_8h.html#ca6b87323f9ce0bf21b3f06209a97989">00249</a> <span class="keywordtype">void</span> <a class="code" href="cr_8c.html#ca6b87323f9ce0bf21b3f06209a97989" title="cr_lib&amp;#39;s initialization function.">cr_init</a>( <a class="code" href="struct_c_r___c_o_n_t_e_x_t.html" title="Coroutine context information.">CR_CONTEXT</a>*    cr_context,
<a name="l00250"></a>00250               <span class="keywordtype">size_t</span>         cr_context_count )
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <span class="comment">// Init the array of CR_CONTEXT structs as well as the globals.</span>
<a name="l00253"></a>00253     assert( cr_context &amp;&amp; <span class="stringliteral">"user param cr_context must be non-zero!\n"</span> );
<a name="l00254"></a>00254     assert( ( cr_context_count &gt; 0 ) &amp;&amp; <span class="stringliteral">"user param cr_context_count must be non-zero!\n"</span> );
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     memset( cr_context, 0, cr_context_count * <span class="keyword">sizeof</span>( <a class="code" href="struct_c_r___c_o_n_t_e_x_t.html" title="Coroutine context information.">CR_CONTEXT</a> ) );
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     cr_g_context        = cr_context;
<a name="l00259"></a>00259     <a class="code" href="cr_8c.html#8238e77b653b2cc4905373b805fc3567" title="The number of elements in the coroutine context array.">cr_g_context_cnt</a>    = ( uint32_t ) cr_context_count;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="comment">// Register the idle thread, which should _always_ be the first coroutine registered.</span>
<a name="l00262"></a>00262     <a class="code" href="cr_8c.html#e30bdb4ef569c0678e4cb49829f11bbb" title="Register a function as a coroutine thread.">cr_register_thread</a>( <a class="code" href="cr_8c.html#ccd73b48023970380bfdecb56483976c" title="The internal system&amp;#39;s coroutine thread.">cr_idle</a> );
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00274"></a><a class="code" href="cr_8h.html#ccd73b48023970380bfdecb56483976c">00274</a> <span class="keywordtype">void</span> <a class="code" href="cr_8c.html#ccd73b48023970380bfdecb56483976c" title="The internal system&amp;#39;s coroutine thread.">cr_idle</a>( <span class="keywordtype">void</span> )
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <span class="comment">// This needs to be static because the function initially returns normally.</span>
<a name="l00277"></a>00277     <span class="keyword">static</span> <a class="code" href="cr_8h.html#e9a0f05a9df6e08a47e828db183fa186" title="Coroutine ID typedef.">cr_id_t</a> temp_id;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <a class="code" href="cr_8h.html#c68ef77f5ea5f5dda5a2f046a2c96429" title="Initializes a function as a coroutine.">CR_THREAD_INIT</a>( );
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     assert( ( this_id__ == <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a> ) &amp;&amp; <span class="stringliteral">"cr_idle: this_id__ != CR_IDLE_THREAD_ID!\n"</span> );
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="comment">// This will be the entry point when longjump is called with cr_idle's context.</span>
<a name="l00284"></a>00284     <span class="comment">// No need to perform another setjmp from within the loop; not much happening.</span>
<a name="l00285"></a>00285     <span class="keywordflow">for</span> ( ; ; )
<a name="l00286"></a>00286     {
<a name="l00287"></a>00287         <span class="comment">// Spin until a non-idle thread is activated.</span>
<a name="l00288"></a>00288         <span class="keywordflow">if</span> ( <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a> == <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a> )
<a name="l00289"></a>00289         {
<a name="l00290"></a>00290             <span class="keywordflow">continue</span>;
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         assert( ( <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a> != <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b7cd063e5de520275d94952e07b5f29b18">CR_INVALID_ID</a> ) &amp;&amp; <span class="stringliteral">"cr_idle: cr_g_activate_id == CR_INVALID_ID!\n"</span> );
<a name="l00294"></a>00294         assert( ( ( uint32_t ) <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a> &lt;= <a class="code" href="cr_8c.html#8238e77b653b2cc4905373b805fc3567" title="The number of elements in the coroutine context array.">cr_g_context_cnt</a>) &amp;&amp; <span class="stringliteral">"cr_idle: cr_g_activate_id out of bounds!\n"</span> );
<a name="l00295"></a>00295         assert( ( <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a> != this_id__ ) &amp;&amp; <span class="stringliteral">"cr_idle: recursive coroutine call!\n"</span> );
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         temp_id             = <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a>;
<a name="l00298"></a>00298         <a class="code" href="cr_8c.html#1345c6db4d2d1d939e7841da46704d8e" title="Holds the ID of the coroutine to be activated - by cr_idle.">cr_g_activate_id</a>    = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a>;
<a name="l00299"></a>00299         <a class="code" href="cr_8c.html#e7e93574baec3ae2b083c7f36916fbbd" title="The ID of the previously active coroutine.">cr_g_previous_cr_id</a> = <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         <span class="keywordflow">if</span> ( !setjmp( cr_g_context[ <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a> ].env ) )
<a name="l00302"></a>00302         {
<a name="l00303"></a>00303             longjmp( cr_g_context[ temp_id ].env, <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b77f396d7461f79cb150ed6b69934f58ec">SETJMP_DFLT_RET_VAL</a> );
<a name="l00304"></a>00304         }
<a name="l00305"></a>00305         <span class="keywordflow">else</span>
<a name="l00306"></a>00306         {
<a name="l00307"></a>00307             <span class="comment">/* explicit block for the longjmp */</span> ;
<a name="l00308"></a>00308         }
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00326"></a><a class="code" href="cr_8h.html#e30bdb4ef569c0678e4cb49829f11bbb">00326</a> <a class="code" href="cr_8h.html#e9a0f05a9df6e08a47e828db183fa186" title="Coroutine ID typedef.">cr_id_t</a> <a class="code" href="cr_8c.html#e30bdb4ef569c0678e4cb49829f11bbb" title="Register a function as a coroutine thread.">cr_register_thread</a>( <span class="keywordtype">void</span> ( *pFunc )( <span class="keywordtype">void</span> ) )
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328     <span class="comment">// Increase the coroutine count.</span>
<a name="l00329"></a>00329     cr_g_thread_cnt += 1;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">if</span> ( cr_g_thread_cnt == <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b760cd04d936d5d89f7468cf9f5240a487">CR_IDLE_THREAD_ID</a> )
<a name="l00332"></a>00332     {
<a name="l00333"></a>00333         <span class="keywordflow">if</span> ( pFunc != <a class="code" href="cr_8c.html#ccd73b48023970380bfdecb56483976c" title="The internal system&amp;#39;s coroutine thread.">cr_idle</a> )
<a name="l00334"></a>00334         {
<a name="l00335"></a>00335             perror( <span class="stringliteral">"cr_idle error: cr_g_thread_cnt !=  CR_IDLE_THREAD_ID. Note, coroutines shouldn't be registered prior to calling cr_init."</span> );
<a name="l00336"></a>00336         }
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     assert( pFunc &amp;&amp; <span class="stringliteral">"cr_register_thread: pFunc is invalid!\n"</span> );
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="comment">// Account fot the cr_idle coroutine (one reserved index in the array) in the assert check.</span>
<a name="l00342"></a>00342     assert( ( cr_g_thread_cnt &lt; <a class="code" href="cr_8c.html#8238e77b653b2cc4905373b805fc3567" title="The number of elements in the coroutine context array.">cr_g_context_cnt</a>) &amp;&amp;
<a name="l00343"></a>00343                 <span class="stringliteral">"cr_register_thread: [ cr_g_thread_cnt &lt; cr_g_context_cnt ] failed\n"</span> );
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="comment">// Assign the coroutine's ID and function pointer to its context structure</span>
<a name="l00346"></a>00346     cr_g_context[ cr_g_thread_cnt ].<a class="code" href="struct_c_r___c_o_n_t_e_x_t.html#2894e7a5d8dde2c904c0914e4aa23293">id</a>    = cr_g_thread_cnt;
<a name="l00347"></a>00347     cr_g_context[ cr_g_thread_cnt ].<a class="code" href="struct_c_r___c_o_n_t_e_x_t.html#8d214b145f897b07864a4c668daaf0e9">pFunc</a> = pFunc;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="comment">// cr_g_current_cr_id is used by the CR_THREAD_INIT macro to identify</span>
<a name="l00350"></a>00350     <span class="comment">// the coroutine.</span>
<a name="l00351"></a>00351     <a class="code" href="cr_8c.html#cf4ab64c8de56045d84e53b65dba7eb8" title="The ID of the coroutine that&amp;#39;s active.">cr_g_current_cr_id</a> = cr_g_thread_cnt;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="keywordflow">if</span> ( !setjmp( cr_g_reg_func_env ) )
<a name="l00354"></a>00354     {
<a name="l00355"></a>00355         pFunc( ); <span class="comment">// this function won't return normally</span>
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357     <span class="keywordflow">else</span>
<a name="l00358"></a>00358     {
<a name="l00359"></a>00359         <span class="comment">/* explicit block for the longjmp */</span> ;
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     <span class="comment">// The function is now a coroutine.</span>
<a name="l00363"></a>00363     <span class="comment">// This is where we return from CR_THREAD_INIT via the longjump.</span>
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="comment">// A sentinal. At init the coroutine returned via a longjump so the return</span>
<a name="l00366"></a>00366     <span class="comment">// point saved in the function's prolog is valid and will return here</span>
<a name="l00367"></a>00367     <span class="comment">// should the coroutine actually return normally via the epilog code.</span>
<a name="l00368"></a>00368     <span class="keywordflow">if</span> ( <a class="code" href="cr_8c.html#00999e3368c59592db0c069abf1f1296" title="Flag that&amp;#39;s set when CR_START is called.">cr_g_sys_started</a> == <a class="code" href="cr_8h.html#df764cbdea00d65edcd07bb9953ad2b701288475e3cc36707461f9b757d00e74">CR_SYSTEM_STARTED</a> )
<a name="l00369"></a>00369     {
<a name="l00370"></a>00370         <span class="comment">// What to do?</span>
<a name="l00371"></a>00371         <span class="comment">// - nothing and return normally</span>
<a name="l00372"></a>00372         <span class="comment">// - yield to whatever is in cr_g_previous_cr_id</span>
<a name="l00373"></a>00373         <span class="comment">// - yield to cr_idle</span>
<a name="l00374"></a>00374         <span class="comment">// - assert</span>
<a name="l00375"></a>00375         <span class="comment">// - exit</span>
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <span class="comment">// Note, cr_g_current_cr_id holds the ID of the exiting coroutine.</span>
<a name="l00378"></a>00378         <span class="comment">// Note, cr_g_previous_cr_id holds the ID of the previous coroutine.</span>
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="comment">// Note, it's not possible to remove the exiting coroutine from the</span>
<a name="l00381"></a>00381         <span class="comment">// context array because the remaining coroutine ID's cannot be changed,</span>
<a name="l00382"></a>00382         <span class="comment">// a coroutine's ID is the index into the context array.</span>
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         <span class="comment">// Look at the cr_g_current_cr_id variable in a debugger to see the ID</span>
<a name="l00385"></a>00385         <span class="comment">// of the exiting coroutine.</span>
<a name="l00386"></a>00386         assert( <a class="code" href="cr_8c.html#06fc87d81c62e9abb8790b6e5713c55b84eb6a791d344cea4fadd2638f7b460e">CR_ERROR_CR_EXITING</a> &amp;&amp; <span class="stringliteral">"cr_register_thread: coruotine exiting!\n"</span> );
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="comment">// Pass EXIT_SUCCESS; we want any user registered clean-up functions to be called.</span>
<a name="l00389"></a>00389         exit( EXIT_SUCCESS );
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="keywordflow">return</span> cr_g_thread_cnt;
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="comment">// end of file</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jan 25 13:04:58 2010 for cr_lib by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
